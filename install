#! /usr/bin/env bash
cd `dirname $0`

HOST=${1-$(lsb_release -cs)}

if test ! -e ./bjam
then {
    cd boost-build
    echo Create build tools
    ./bootstrap.sh
    cp bjam ..
    cd ..
}
fi
cp ./bjam ..

echo Making boost-build.jam
rm -f ../boost-build.jam
echo BOOST_ROOT = \$\(.boost-build-file:D\) \;>>../boost-build.jam
echo BOOST_BUILD = \[ MATCH --boost-build=\(.*\) : \$\(ARGV\) \] \;>>../boost-build.jam
echo BOOST_BUILD ?= Boost/boost-build/src \;>>../boost-build.jam
echo boost-build \$\(BOOST_BUILD\) \;>>../boost-build.jam

if [[ $HOST =~ [a-z]+ ]]
then {
    if [[ "$HOST" == "wily" || "$HOST" == "xenial" || "$HOST" == "yakkety" ]]
    then {
        BOOST_MAJOR=58
    }
    elif [[ "$HOST" == "utopic" || "$HOST" == "vivid" ]]
    then {
        echo BOOST_MAJOR=55 is too old
        exit 2
    }
    elif [[ "$HOST" == "trusty" ]]
    then {
        echo BOOST_MAJOR=54 is too old
        exit 2
    }
    elif [[ "$HOST" == "saucy" ]]
    then {
        echo BOOST_MAJOR=53 is too old
        exit 2
    }
    elif [[ "$HOST" == "quantal" || "$HOST" == "raring" ]]
    then {
        echo BOOST_MAJOR=49 is too old
        exit 2
    }
    elif [[ "$HOST" == "precise" ]]
    then {
         echo BOOST_MAJOR=46 is too old
         exit 2
    }
    elif [ "$HOST" == "lucid" ]
    then {
        echo BOOST_MAJOR=40 is too old
        exit 2
    } else {
        echo Unknown code name: $HOST
        exit 1
    }
    fi

    echo Making boost-version.jam
    echo BUILD_DIRECTORY = \"../build.tmp/$HOST\" \;>../boost-version.jam
    echo BOOST_VERSION_MAJOR = \"$BOOST_MAJOR\" \;>> ../boost-version.jam

    echo Creating target preservation script
    echo echo --preserve-test-targets > ../python.opts.sh
    chmod +x ../python.opts.sh

    JAMROOT=Jamroot.$HOST
}
else {
    echo Making boost-version.jam
    rm -f ../boost-version.jam
    echo BOOST_VERSION_MAJOR = \"$1\" \;>> ../boost-version.jam
    echo BOOST_VERSION_MINOR = \"$2\" \;>> ../boost-version.jam
    echo BUILD_DIRECTORY = \"../build.tmp/1_$1_$2\" \;>> ../boost-version.jam

    echo Creating target preservation script
    if test $1 -lt 38
    then {
        echo echo --preserve-test-targets > ../python.opts.sh
    } else {
        echo echo preserve-test-targets=on > ../python.opts.sh
    }
    fi
    chmod +x ../python.opts.sh

    JAMROOT=Jamroot.ownbuild-versioned-layout
}
fi
echo Using $JAMROOT
cp $JAMROOT Jamroot

echo Installing colorbb
colorbb/use_colorbb
